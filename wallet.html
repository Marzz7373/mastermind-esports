<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mastermind Esports Wallet</title>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #0C0F2C 0%, #14183A 100%);
      color: #E0E4F3;
      text-align: center;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 400px;
      margin: 0 auto;
      padding-top: 50px;
    }

    .wallet-box {
      background: #1F244A;
      border: 2px solid rgba(255, 179, 0, 0.3);
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .wallet-box h2 {
      color: #FFB300;
      margin-bottom: 1.5rem;
      font-size: 1.5rem;
    }

    input {
      width: 100%;
      padding: 12px 16px;
      margin: 10px 0;
      border-radius: 8px;
      border: 1px solid #334155;
      background: #0C0F2C;
      color: #E0E4F3;
      font-size: 16px;
      box-sizing: border-box;
    }

    input:focus {
      border-color: #FFB300;
      outline: none;
    }

    button {
      background: #FFB300;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      color: #0C0F2C;
      margin: 10px 5px;
      font-size: 16px;
      transition: all 0.3s;
      width: 100%;
    }

    button:hover {
      background: #FF6600;
      transform: translateY(-2px);
    }

    button:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
    }

    .result {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      background: rgba(255, 179, 0, 0.1);
      border: 1px solid rgba(255, 179, 0, 0.3);
    }

    .error {
      background: rgba(255, 107, 107, 0.1);
      border-color: rgba(255, 107, 107, 0.3);
      color: #ff6b6b;
    }

    .success {
      background: rgba(0, 255, 204, 0.1);
      border-color: rgba(0, 255, 204, 0.3);
      color: #00ffcc;
    }

    .admin-section {
      margin-top: 2rem;
      padding-top: 2rem;
      border-top: 1px solid rgba(255, 179, 0, 0.3);
      display: none;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #FFB300;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="wallet-box">
      <h2>ðŸ’³ Mastermind Esports Wallet</h2>

      <input id="phone" type="tel" placeholder="Enter your phone number (e.g., 60123456789)" />
      <button onclick="checkBalance()" id="checkBtn">Check Balance</button>

      <div id="result"></div>

      <div id="adminSection" class="admin-section">
        <h3 style="color: #FFB300; margin-bottom: 1rem;">Admin Panel</h3>
        <input id="amount" type="number" step="0.01" placeholder="Amount (e.g., 50 for add, -10 for deduct)">
        <input id="adminKey" type="password" placeholder="Admin Authentication Key">
        <button onclick="updateBalance()" id="updateBtn">Update Balance</button>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const CONFIG = {
      API_URL: "https://script.google.com/macros/s/AKfycbxvB9OdTbF--CuYT9QV6gAF5tUM-W7JU2wE7no2Iztewuy2tZtkX5W5MwJeC65ypA9h7Q/exec",
      MAX_RETRIES: 3,
      TIMEOUT: 10000
    };

    // Utility functions
    function showLoading(buttonId, text = "Processing...") {
      const btn = document.getElementById(buttonId);
      btn.innerHTML = `<span class="loading"></span> ${text}`;
      btn.disabled = true;
    }

    function hideLoading(buttonId, text) {
      const btn = document.getElementById(buttonId);
      btn.innerHTML = text;
      btn.disabled = false;
    }

    function showResult(message, type = 'info') {
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = message;
      resultDiv.className = `result ${type}`;
      resultDiv.style.display = 'block';
    }

    function validatePhone(phone) {
      // Malaysian phone number validation
      const phoneRegex = /^(\+?6?01)[0-46-9]-*[0-9]{7,8}$|^(\+?6?0)[2-9]-*[0-9]{7,8}$/;
      return phoneRegex.test(phone.replace(/\s+/g, ''));
    }

    async function makeAPICall(data, retries = 0) {
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), CONFIG.TIMEOUT);

        const response = await fetch(CONFIG.API_URL, {
          method: "POST",
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data),
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        return await response.json();
      } catch (error) {
        if (retries < CONFIG.MAX_RETRIES) {
          console.log(`Retry attempt ${retries + 1}`);
          await new Promise(resolve => setTimeout(resolve, 1000 * (retries + 1)));
          return makeAPICall(data, retries + 1);
        }
        throw error;
      }
    }

    async function checkBalance() {
      const phone = document.getElementById('phone').value.trim();

      if (!phone) {
        showResult("Please enter your phone number.", 'error');
        return;
      }

      if (!validatePhone(phone)) {
        showResult("Please enter a valid Malaysian phone number.", 'error');
        return;
      }

      showLoading('checkBtn', 'Checking...');

      try {
        const data = await makeAPICall({
          action: "getBalance",
          phone: phone
        });

        if (data.balance !== undefined && !data.error) {
          // Get transaction history
          const historyData = await makeAPICall({
            action: "getHistory",
            phone: phone
          });

          let historyFormatted = 'No transaction history';
          if (historyData.history && historyData.history.length > 0) {
            historyFormatted = historyData.history.map(h => 
              `${h.date}: ${h.type} RM${h.amount}`
            ).join('<br>');
          }

          showResult(`
            <h3 style="color: #FFB300; margin-bottom: 10px;">${data.name || 'Customer'}</h3>
            <p style="font-size: 1.2em; margin: 10px 0;"><strong>Balance: RM${data.balance}</strong></p>
            <div style="margin-top: 15px; text-align: left;">
              <strong>Transaction History:</strong><br>
              <small style="line-height: 1.4;">${historyFormatted}</small>
            </div>
          `, 'success');

          // Show admin panel for authorized users
          document.getElementById("adminSection").style.display = "block";
        } else {
          showResult(data.error || "Phone number not found in our system.", 'error');
        }
      } catch (error) {
        console.error('Error:', error);
        showResult("Connection error. Please check your internet and try again.", 'error');
      } finally {
        hideLoading('checkBtn', 'Check Balance');
      }
    }

    async function updateBalance() {
      const phone = document.getElementById('phone').value.trim();
      const amount = parseFloat(document.getElementById('amount').value);
      const adminKey = document.getElementById('adminKey').value.trim();

      if (!phone || isNaN(amount) || !adminKey) {
        showResult("Please fill all fields correctly!", 'error');
        return;
      }

      if (!validatePhone(phone)) {
        showResult("Please enter a valid Malaysian phone number.", 'error');
        return;
      }

      showLoading('updateBtn', 'Updating...');

      try {
        // Simple admin key check (you can change this)
        if (adminKey !== "MASTER2025") {
          showResult("Invalid admin key!", 'error');
          return;
        }

        const data = await makeAPICall({
          action: "updateBalance",
          phone: phone,
          amount: amount
        });

        if (data.success) {
          showResult(`âœ… Balance updated successfully!<br>New Balance: <strong>RM${data.balance}</strong>`, 'success');

          // Clear admin fields
          document.getElementById('amount').value = '';
          document.getElementById('adminKey').value = '';

          // Refresh balance display
          setTimeout(() => checkBalance(), 1000);
        } else {
          showResult(data.error || "Update failed. Please try again.", 'error');
        }
      } catch (error) {
        console.error('Error:', error);
        showResult("Connection error. Please try again.", 'error');
      } finally {
        hideLoading('updateBtn', 'Update Balance');
      }
    }

    // Event listeners
    document.getElementById('phone').addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        checkBalance();
      }
    });

    document.getElementById('adminKey').addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        updateBalance();
      }
    });

    // Auto-format phone number
    document.getElementById('phone').addEventListener('input', function (e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.startsWith('60')) {
        // Already has country code
      } else if (value.startsWith('0')) {
        value = '6' + value;
      } else if (value.startsWith('1')) {
        value = '60' + value;
      }
      e.target.value = value;
    });
  </script>
</body>

</html>
